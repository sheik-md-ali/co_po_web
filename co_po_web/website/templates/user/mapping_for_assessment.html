<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapping for Assessment</title>
</head>
<body>
    <a href="{{ url_for('auth.back_to_dashboard') }}" class="back-button">Back to Dashboard</a>

    <div class="container">
        <div class="section">
            <h2>Question based Mapping</h2>
            <h3>Map the questions with the respective COs and define the marks.</h3>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div>
                {% for message in messages %}
                <p>{{ message }}</p>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Form for selecting Subject, Section, and Assessment Instance -->
            <form method="post" action="{{ url_for('user_routes.mapping_for_assessment') }}">
                <div>
                    <label for="subjectCode">Subject Code:</label>
                    <select id="subjectCode" name="subject_code" onchange="this.form.submit()">
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                            <option value="{{ subject }}" {% if selected_subject_code == subject %}selected{% endif %}>{{ subject }}</option>
                        {% endfor %}
                    </select>
                </div>                
                {% if sections %}
                <div>
                    <label for="section">Section:</label>
                    <select id="section" name="section" onchange="this.form.submit()">
                        <option value="">Select Section</option>
                        {% for section in sections %}
                        <option value="{{ section.name }}" {% if selected_section_name == section.name %}selected{% endif %}>
                            {{ section.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                {% endif %}
                {% if assessment_instances %}
                <div>
                    <label for="assessmentInstance">Assessment Instance:</label>
                    <select id="assessmentInstance" name="assessment_instance" onchange="this.form.submit()">
                        <option value="">Select Assessment Instance</option>
                        {% for instance in assessment_instances %}
                        <option value="{{ instance.id }}" {% if selected_assessment_instance_id == instance.id %}selected{% endif %}>
                            {{ instance.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </form>

            {% if selected_subject_code and selected_section_name and not assessment_instances %}
            <p>No assessments exist for the selected subject and section.</p>
            {% endif %}

            {% if assessment_details %}
            <div id="assessmentDetails">
                <h3>Assessment: {{ assessment_details.name }}</h3>
                <p>Max Marks: {{ assessment_details.max_marks }}</p>
            </div>

            <!-- Form for mapping questions -->
            <form method="post" action="{{ url_for('user_routes.save_or_submit_assessment') }}">
                <div class="add-question-btn">
                    <button id="addQuestionBtn" type="button">+ Add Question</button>
                </div>
                <input type="hidden" name="selected_subject_code" value="{{ selected_subject_code }}">
                <input type="hidden" name="selected_section_name" value="{{ selected_section_name }}">
                <input type="hidden" name="selected_assessment_instance_id" value="{{ selected_assessment_instance_id }}">
                <input type="hidden" id="question_count" name="question_count" value="0"> <!-- Hidden input for question count -->

                <div class="questions-container">
                    <!-- Questions will be dynamically added here -->
                </div>

                <div>
                    <button type="submit" name="action" value="save">Save</button>
                    <button type="submit" name="action" value="submit">Submit</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const addQuestionBtn = document.getElementById("addQuestionBtn");
        const questionsContainer = document.querySelector(".questions-container");
        let questionCounter = 0;

        function addQuestion() {
            questionCounter++;
            const questionWrapper = document.createElement("div");
            questionWrapper.classList.add("question");

            const questionNumberInput = document.createElement("input");
            questionNumberInput.type = "text";
            questionNumberInput.readOnly = true;
            questionNumberInput.value = `Question ${questionCounter}`;
            questionNumberInput.classList.add("question-number");

            const maxMarksInput = document.createElement("input");
            maxMarksInput.type = "text";
            maxMarksInput.placeholder = "Max Marks";
            maxMarksInput.name = `question${questionCounter}_maxMarks`; // Use indexed names

            const coDropdown = document.createElement("select");
            coDropdown.name = `question${questionCounter}_co`; // Use indexed names
            for (let i = 1; i <= 6; i++) {
                const coOption = document.createElement("option");
                coOption.value = `CO${i}`;
                coOption.textContent = `CO${i}`;
                coDropdown.appendChild(coOption);
            }

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.textContent = "Remove";
            removeBtn.classList.add("remove-question-btn");
            removeBtn.addEventListener("click", function() {
                questionsContainer.removeChild(questionWrapper);
                questionCounter--;
                updateQuestionNumbers();
                updateQuestionCount(); // Update question count
            });

            questionWrapper.appendChild(questionNumberInput);
            questionWrapper.appendChild(maxMarksInput);
            questionWrapper.appendChild(coDropdown);
            questionWrapper.appendChild(removeBtn);

            questionsContainer.appendChild(questionWrapper);
            updateQuestionCount(); // Update question count
        }

        function updateQuestionNumbers() {
            const questionNumbers = document.querySelectorAll(".question-number");
            questionNumbers.forEach((number, index) => {
                number.value = `Question ${index + 1}`;
            });
        }

        function updateQuestionCount() {
            document.getElementById("question_count").value = questionCounter; // Update hidden question count input
        }

        // Add initial questions
        for (let i = 0; i < 10; i++) {
            addQuestion();
        }

        addQuestionBtn.addEventListener("click", function() {
            addQuestion();
        });
    });
    </script>

</body>
</html>
